<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>äº”å¹´çº§ä¸‹å†Œå­—è¯å¬å†™ (è°ƒé€Ÿç‰ˆ)</title>

  <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

  <style>
    :root {
      --primary: #ea580c;
      --primary-hover: #c2410c;
      --bg: #fff7ed;
      --card: #ffffff;
      --text: #431407;
      --accent: #f97316;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
      background: linear-gradient(135deg, #fff7ed 0%, #ffedd5 100%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 20px;
    }

    .container {
      background: var(--card);
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      width: 100%;
      max-width: 800px;
      padding: 30px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    header { text-align: center; margin-bottom: 10px; }
    h1 { color: var(--primary); font-size: 1.8rem; margin-bottom: 10px; }
    .subtitle { color: #9a3412; font-size: 0.95rem; font-weight: bold; background: #ffedd5; padding: 5px 15px; border-radius: 15px; display: inline-block;}

    /* ====== æ–°å¢ï¼šè½»é‡é—¯å…³æ°›å›´ï¼ˆä¸å¤æ‚ï¼‰ ====== */
    .hero {
      background: linear-gradient(135deg, rgba(234,88,12,0.10), rgba(249,115,22,0.08));
      border: 1px solid #fed7aa;
      border-radius: 16px;
      padding: 14px 16px;
      display: flex;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
    }
    .hero-left { display:flex; gap:10px; align-items:center; }
    .badge-icon{
      width:42px; height:42px; border-radius: 12px;
      background:#ffedd5; display:flex; align-items:center; justify-content:center;
      font-size: 1.2rem; border: 1px solid #fed7aa;
      box-shadow: 0 4px 10px rgba(234,88,12,0.08);
    }
    .hero-title{ font-weight: 800; color:#9a3412; font-size: 1.05rem; line-height:1.2; }
    .hero-sub{ font-size: 0.88rem; color:#7c2d12; opacity:0.9; margin-top:2px; }

    .mini-stats{ display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; }
    .pill{
      background:#fff; border:1px solid #fed7aa; color:#9a3412;
      padding:6px 10px; border-radius: 999px; font-weight:700; font-size:0.82rem;
      display:flex; gap:6px; align-items:center;
    }

    .quote-card{
      background:#fff; border:1px dashed #fdba74; border-radius: 14px;
      padding: 12px 14px; line-height:1.55; color:#7c2d12;
    }
    .quote-strong{ font-weight: 800; color:#c2410c; }

    .running-tip{
      margin-top: 10px;
      background: rgba(255,247,237,0.9);
      border:1px solid #fed7aa;
      border-radius: 14px;
      padding: 10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .level-chip{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 12px; border-radius:999px;
      background:#fff7ed; border:1px solid #fed7aa;
      color:#9a3412; font-weight:800; font-size:0.85rem;
    }
    .spark{ display:inline-block; margin-left:6px; animation: pop 900ms ease-in-out infinite; }
    @keyframes pop{ 0%,100%{transform:translateY(0)} 50%{transform:translateY(-2px)} }

    .running-tip .tip-text{ font-size:0.9rem; color:#7c2d12; font-weight:800; }
    .running-tip .tip-sub{ font-size:0.78rem; color:#9a3412; opacity:0.9; margin-top:2px; font-weight:600; }

    .milestone{
      font-size:0.82rem; color:#166534; background:#dcfce7;
      border:1px solid #86efac; padding:6px 10px; border-radius:999px;
      font-weight:800; display:none;
      white-space: nowrap;
    }
    /* ====== æ–°å¢ç»“æŸ ====== */

    .setup-panel {
      border: 2px dashed #fdba74;
      border-radius: 12px;
      padding: 20px;
      background: #fff;
      transition: all 0.3s;
    }

    .lesson-selector-area {
      background: #fff7ed;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
      border: 1px solid #fed7aa;
    }

    .lesson-select {
      width: 100%;
      padding: 12px;
      font-size: 1.1rem;
      border: 2px solid var(--accent);
      border-radius: 8px;
      color: var(--primary-hover);
      background: white;
      cursor: pointer;
      font-weight: bold;
      outline: none;
    }

    .preview-box {
      font-size: 0.9rem;
      color: #666;
      margin-top: 10px;
      padding: 10px;
      background: rgba(255,255,255,0.8);
      border-radius: 5px;
      max-height: 120px;
      overflow-y: auto;
      border: 1px solid #eee;
      line-height: 1.6;
    }

    .settings-row {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }
    .setting-group { display: flex; align-items: center; gap: 8px; font-weight: 500;}
    select { padding: 8px 5px; border-radius: 5px; border: 1px solid #ccc; background: white; font-size: 1rem;}

    .main-btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 50px;
      font-size: 1.3rem;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      transition: transform 0.2s, background 0.2s;
      box-shadow: 0 4px 15px rgba(234, 88, 12, 0.3);
    }
    .main-btn:active { transform: scale(0.98); }

    /* Running Mode UI */
    .running-ui { display: none; text-align: center; padding: 20px 0; }

    .status-badge {
      display: inline-block;
      background: #ffedd5;
      color: var(--primary);
      padding: 6px 16px;
      border-radius: 20px;
      font-weight: 600;
      margin-bottom: 20px;
    }

    .big-word-display {
      font-size: 3.5rem;
      font-weight: 800;
      color: var(--text);
      margin: 20px 0;
      min-height: 80px;
      font-family: "KaiTi", "æ¥·ä½“", serif;
      line-height: 1.2;
    }

    .progress-bar {
      height: 10px;
      background: #fee2e2;
      border-radius: 5px;
      overflow: hidden;
      margin: 20px 0;
    }
    .progress-fill {
      height: 100%;
      background: var(--primary);
      width: 0%;
      transition: width 0.3s;
    }

    .control-btns { display: flex; justify-content: center; gap: 15px; margin-top: 30px;}
    .control-btn {
      padding: 12px 28px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      font-size: 1rem;
      transition: all 0.2s;
    }
    .btn-pause { background: #fef9c3; color: #b45309; border: 1px solid #fde047; }
    .btn-stop { background: #fee2e2; color: #b91c1c; border: 1px solid #fecaca; }

    .answer-list {
      margin-top: 30px;
      text-align: left;
      background: #fff7ed;
      padding: 20px;
      border-radius: 12px;
      display: none;
    }
    .answer-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
      gap: 10px;
    }
    .answer-item {
      background: white;
      padding: 10px 5px;
      border-radius: 8px;
      text-align: center;
      font-size: 1rem;
      font-weight: bold;
      color: #c2410c;
      border: 1px solid #fdba74;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .expand-toggle {
      text-align: center;
      color: #888;
      cursor: pointer;
      font-size: 0.85rem;
      margin-top: 15px;
      text-decoration: underline;
    }
    #customInputArea { display: none; margin-top: 15px; padding-top: 15px; border-top: 1px dashed #eee;}
    textarea { width: 100%; height: 80px; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-family: inherit;}
  </style>
</head>

<body>
  <div class="container">
    <header>
      <h1>äº”å¹´çº§ä¸‹å†Œ Â· è¯­æ–‡å¬å†™</h1>
      <span class="subtitle">åŒ…å«å†™å­—è¡¨ç»„è¯ & è¯è¯­è¡¨</span>
    </header>

    <!-- æ–°å¢ï¼šé—¯å…³æ¨ªå¹… + ä»Šæ—¥æ‰“æ°” -->
    <div class="hero">
      <div class="hero-left">
        <div class="badge-icon">ğŸ</div>
        <div>
          <div class="hero-title">ä»Šæ—¥å¬å†™é—¯å…³ Â· ä¸€å°æ­¥ä¹Ÿç®—è¿›æ­¥</div>
          <div class="hero-sub">ç§¯å°‘æˆå¤šï¼Œæ¯ä¸€æ¬¡è®¤çœŸè½ç¬”éƒ½åœ¨å˜å¼º ğŸ’ª</div>
        </div>
      </div>

      <div class="mini-stats">
        <div class="pill"><span>ğŸ¯</span><span id="todayGoal">ç›®æ ‡ï¼šâ€”</span></div>
        <div class="pill"><span>ğŸ”¥</span><span id="streak">è¿ç»­ï¼š0å¤©</span></div>
      </div>
    </div>

    <div class="quote-card">
      <span class="quote-strong">ä»Šæ—¥æ‰“æ°”ï¼š</span>
      <span id="quoteText">æ¯å†™å¯¹ä¸€ä¸ªå­—ï¼Œéƒ½æ˜¯åœ¨ç»™æœªæ¥çš„è‡ªå·±åŠ åˆ†ã€‚</span>
    </div>
    <!-- æ–°å¢ç»“æŸ -->

    <div id="setupArea" class="setup-panel">

      <div class="lesson-selector-area">
        <label style="display:block; margin-bottom:8px; font-weight:bold; color:#c2410c;">ğŸ“š è¯·é€‰æ‹©å¬å†™èŒƒå›´ï¼š</label>
        <select id="lessonSelect" class="lesson-select" onchange="previewWords()"></select>
        <div class="preview-box" id="wordPreview"></div>
      </div>

      <div class="settings-row">
        <div class="setting-group">
          <label>æœ—è¯»è¯­é€Ÿ:</label>
          <select id="speechRate">
            <option value="1">æ­£å¸¸</option>
            <option value="0.85">ç¨æ…¢</option>
            <option value="0.7" selected>è¾ƒæ…¢ (é»˜è®¤)</option>
            <option value="0.55">å¾ˆæ…¢</option>
          </select>
        </div>

        <div class="setting-group">
          <label>é‡å¤æ¬¡æ•°:</label>
          <select id="repeatCount">
            <option value="1">1æ¬¡</option>
            <option value="2" selected>2æ¬¡</option>
            <option value="3">3æ¬¡</option>
          </select>
        </div>

        <div class="setting-group">
          <label>ä¹¦å†™æ—¶é—´:</label>
          <select id="waitTime">
            <option value="5">5ç§’</option>
            <option value="8" selected>8ç§’</option>
            <option value="12">12ç§’</option>
          </select>
        </div>
      </div>

      <button class="main-btn" onclick="initDictation()">ğŸ§ å¼€å§‹å¬å†™</button>

      <div class="expand-toggle" onclick="toggleCustomArea()">+ è‡ªå®šä¹‰/è¯†åˆ«å›¾ç‰‡æ–‡å­—</div>
      <div id="customInputArea">
        <p style="font-size:0.8rem; color:#666; margin-bottom:5px;">ç²˜è´´æ–‡å­—æˆ–ä¸Šä¼ PDFæ–‡ä»¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æå–ä¸­æ–‡è¯è¯­ã€‚</p>
        <textarea id="customWordInput" placeholder="åœ¨æ­¤ç²˜è´´è¯è¯­..."></textarea>
        <input type="file" accept="application/pdf" onchange="handlePdfUpload(event)" style="margin-top:8px;">
        <div id="ocrStatus" style="font-size:0.8rem; color:green; margin-top:5px;"></div>
      </div>
    </div>

    <div id="runningArea" class="running-ui">
      <div class="status-badge" id="progressText">è¿›åº¦: 0 / 0</div>

      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>

      <div class="big-word-display" id="wordDisplay">å‡†å¤‡</div>
      <div style="color: #64748b; font-size: 0.9rem;" id="statusMsg">ç‚¹å‡»å¼€å§‹</div>

      <!-- æ–°å¢ï¼šå…³å¡&é¼“åŠ±æ¡ -->
      <div class="running-tip">
        <div style="text-align:left;">
          <div class="tip-text">
            <span class="level-chip" id="levelChip">ç¬¬ 1 å…³<span class="spark">âœ¨</span></span>
            <span style="margin-left:10px;" id="runQuote">æŠŠâ€œä¸ä¼šâ€æ”¹æˆâ€œè¿˜æ²¡ä¼šâ€ã€‚</span>
          </div>
          <div class="tip-sub" id="runSub">å†™æ…¢ä¸€ç‚¹ä¹Ÿæ²¡å…³ç³»ï¼Œå†™å‡†æ›´é‡è¦ã€‚</div>
        </div>
        <div class="milestone" id="milestoneBadge">é‡Œç¨‹ç¢‘ +1</div>
      </div>
      <!-- æ–°å¢ç»“æŸ -->

      <div class="control-btns">
        <button class="control-btn btn-pause" id="pauseBtn" onclick="togglePause()">æš‚åœ</button>
        <button class="control-btn btn-stop" onclick="stopDictation()">ç»“æŸ</button>
      </div>

      <div class="answer-list" id="answerList"></div>
    </div>
  </div>

  <script>
    // --- 1. æ ¸å¿ƒæ•°æ®ï¼šæŒ‰è¯¾æ–‡æ•´ç†çš„è¯åº“ ---
    const lessonGroups = [
      {
        name: "ç¬¬1-2è¯¾ (å¤è¯—ã€ç¥–çˆ¶çš„å›­å­)",
        words: [
          "ç™½æ˜¼", "æ˜¼å¤œ", "è€•è€˜", "è€˜ç”°", "æ¡‘æ ‘", "æ¡‘å¶", "æ‹‚æ™“", "å®¶å–»æˆ·æ™“",
          "è´è¶", "è´è¶ç»“", "é£è¶", "ç²‰è¶", "å—¡å—¡å“", "å—¡åŠ¨", "æ¨±èŠ±", "æ¨±æ¡ƒ",
          "æ¦†æ ‘", "æ¦†é’±", "æŒºæ‹”", "æ‹”æ²³", "çè¯´", "çé—¹", "é“²é™¤", "é“é“²",
          "é”„è‰", "é”„å¤´", "æ”¶å‰²", "åˆ†å‰²", "å°¾å·´", "ç»“å°¾", "æ‰¿è®¤", "ç»§æ‰¿",
          "æ‹´ä½", "æ‹´é©¬", "æ°´ç“¢", "ç“¢æ³¼å¤§é›¨", "é—²é€›", "é€›è¡—",
          "èœ»èœ“", "èš‚èš±", "åœ†æ»šæ»š", "æ˜æ™ƒæ™ƒ", "éšæ„"
        ]
      },
      {
        name: "ç¬¬5è¯¾ (è‰èˆ¹å€Ÿç®­)",
        words: [
          "å¦’å¿Œ", "å«‰å¦’", "å¿Œè®³", "é¡¾å¿Œ", "æ›¹æ“", "ç›‘ç£", "éƒ½ç£", "å§”æ‰˜", "å§”å©‰",
          "é²å›½", "ç²—é²", "é®æŒ¡", "é®æ©", "è¿Ÿç–‘", "ç–‘é—®", "å›°æƒ‘", "è¯±æƒ‘", "å±±å¯¨",
          "æ°´å¯¨", "æ“‚é¼“", "æ“‚å°", "å‘å–Š", "å”¢å‘", "æ’å˜´", "æ’ç§§",
          "ç…§åŠ", "é¢„è®¡", "ç´§æ€¥", "å†›ä»¤çŠ¶", "æ¢å¬", "ç§è‡ª", "å¸ƒç½®", "è°ƒåº¦", "ç¥æœºå¦™ç®—"
        ]
      },
      {
        name: "ç¬¬6-9è¯¾ (æ™¯é˜³å†ˆã€å¤è¯—)",
        words: [
          "å±±å†ˆ", "äº•å†ˆå±±", "é¥¥é¥¿", "é¥¥è’", "ç¢Ÿå­", "é£ç¢Ÿ", "å…¬æ–¤", "æ–¤æ–¤è®¡è¾ƒ",
          "ä¿ºä»¬", "æ¦œæ ·", "æ¦œæ–‡", "æ‹æ–", "æ‰‹æ–", "ç”³è¯·", "é‡ç”³", "å…¼èŒ",
          "è½¯ç¡¬å…¼æ–½", "åˆ‡å‹¿", "è¯·å‹¿", "æ‹–å»¶", "æ‹–æ‹‰", "ç†Ÿæ‚‰", "è·æ‚‰", "ä¸‹å ", "å è½",
          "èƒ¸è†›", "æªè†›", "æˆªæ–­", "æˆªæ­¢", "åŠå¤œä¸‰æ›´", "å¯»æ€", "è€»ç¬‘", "æ­¦è‰º",
          "ç¯±ç¬†", "æ¨Šç¯±", "ä»ç„¶", "ä»æ—§", "äº”å²³", "å²³é£", "æ‘©æ“¦", "æŒ‰æ‘©",
          "é—æ†¾", "é—ç•™", "ä¼ é€’", "å¿«é€’", "å·«å©†", "å·«æœ¯"
        ]
      },
      {
        name: "ç¬¬10è¯¾ (é’å±±å¤„å¤„åŸ‹å¿ éª¨)",
        words: [
          "å½­å¾·æ€€", "æ‹Ÿå®š", "æ¨¡æ‹Ÿ", "è®¡è°‹", "å‚è°‹", "ç‘é›ª", "ç¥¥ç‘", "æŸå¤±", "æŸè€—",
          "é”»ç‚¼", "é”»é€ ", "ç£¨ç‚¼", "æç‚¼", "çœ·æ‹", "å®¶çœ·", "å¥”èµ´", "èµ´çº¦", "æå¥½",
          "æå®š", "ç‰¹æ®Š", "æ®Šè£", "å°Šé‡", "å°Šä¸¥", "ç­¾å", "ç­¾è®¢", "é©å‘½", "æ”¹é©",
          "æƒ…ä¸è‡ªç¦", "æ…°é—®", "ç¹å¿™", "ä¸‹æ„è¯†"
        ]
      },
      {
        name: "ç¬¬11è¯¾ (å†›ç¥)",
        words: [
          "åº†ç¥", "å›½åº†", "è¯Šæ–­", "é—¨è¯Š", "è‚¥æ²ƒ", "æ²ƒåœŸ", "å¹´é¾„", "å·¥é¾„", "åœŸåŒª",
          "åŒªå¾’", "ç»·å¸¦", "ç´§ç»·", "å®¡æŸ¥", "å®¡è§†", "è¯å‰‚", "è°ƒå‘³å‰‚", "æ–½å·¥", "æ–½å±•",
          "å­å£°", "å¼•å­é«˜æ­Œ", "å´­æ–°", "å´­éœ²å¤´è§’", "ç”±è¡·", "è‹¦è¡·", "æ…ˆç¥¥", "ä»æ…ˆ",
          "å‰ç¥¥", "å®‰è¯¦", "è¯Šæ‰€", "ç†Ÿç»ƒ", "ä¸€é’ˆè§è¡€", "æ–½è¡Œ", "æ¸…é†’", "é¢¤æŠ–",
          "ä¸€å£°ä¸å­", "è‹ç™½", "è‚ƒç„¶èµ·æ•¬", "è£å¹¸"
        ]
      },
      {
        name: "ç¬¬13è¯¾ (äººç‰©æå†™ä¸€ç»„)",
        words: [
          "æ‘”è·¤", "è·Œè·¤", "æ‚æŠ±", "æ‚ä½", "æ‰“ä»—", "ä¾ä»—", "é­ç­–", "é­ç‚®", "æ¬ºè´Ÿ",
          "æ¬ºéª—", "é˜»æŒ ", "æŒ å¤´", "æ‰³æ‰‹", "æ‰³åŠ¨", "æ‰‹è…•", "è…•åŠ›", "å‰ƒå¤´", "å‰ƒé¡»",
          "è…®å¸®", "ä¸¤è…®", "ä¼¤ç–¤", "ç»“ç–¤", "ç›‘è§†", "ç›‘ç‹±", "ä¾„å­", "ä¾„å¥³", "å–‰å’™",
          "å–‰èˆŒ", "æ‰‹ç–¾çœ¼å¿«", "è„šè…•å­", "æŒºè„±", "è‚¢ä½“", "æ ¼å±€", "å¨ä¸¥"
        ]
      },
      {
        name: "ç¬¬14-15è¯¾ (åˆ·å­æã€è‡ªç›¸çŸ›ç›¾)",
        words: [
          "æ³¥æµ†", "è±†æµ†", "å¸ˆå‚…", "å¤ªå‚…", "åŒ…è¢±", "æ•…éšœ", "å±éšœ", "èŠéº»", "çµèŠ",
          "ç¥åœ£", "åœ£äºº", "çŠ¯é”™", "ä¾µçŠ¯", "éœ²é¦…", "è‚‰é¦…", "è½°ç‚¸", "è½°åŠ¨", "éš¾å ª",
          "ä¸å ªè®¾æƒ³", "è¯ˆéª—", "å…µä¸åŒè¯ˆ", "å‚»ç“œ", "è£…å‚»", "æé€ ", "ææ³¥äºº", "å‘æ€”",
          "æ€”ä½", "ç²‰åˆ·", "ç»æ´»", "æ´¾å¤´", "æ‰‹æ³•", "é¼“ç‚¹", "è¡”æ¥",
          "çŸ›ç›¾", "é•¿çŸ›", "åç›¾", "ç›¾ç‰Œ", "è£èª‰", "åèª‰", "å¾è¾ˆ", "æ”¯å¾"
        ]
      },
      {
        name: "ç¬¬16-17è¯¾ (ç”°å¿Œèµ›é©¬ã€è·³æ°´)",
        words: [
          "è¾“èµ¢", "èµ¢å®¶", "æ‹³å¤´", "æ‹³å‡»", "æ“¦æ‹­", "ç­–ç•¥", "ç­–åˆ’", "æ¨è", "ä¸¾è",
          "èµè¯†", "è„šåŠ›", "èƒ¸æœ‰æˆç«¹", "æ‘©æ‹³æ“¦æŒ", "è·ƒè·ƒæ¬²è¯•", "å…´è‡´å‹ƒå‹ƒ", "å‡ºè°‹åˆ’ç­–", "å¼•è",
          "ä¸€è‰˜èˆ¹", "èˆªç©º", "èˆªè¡Œ", "æ”¾è‚†", "è‚†è™", "å¸½å­", "è‰å¸½", "æ¡…æ†", "æ’•ç ´",
          "æ’•è£‚", "é€—ç¬‘", "é€—ç•™", "å“å”¬", "å”¬äºº", "é±¼é’©", "æŒ‚é’©", "æ‰­æ‰“", "æ‰­ä¼¤",
          "å’§å˜´", "å¤§å¤§å’§å’§", "èˆ¹èˆ±", "æœºèˆ±", "æµ·é¸¥", "å–µå–µå«",
          "é£å¹³æµªé™", "å–ä¹", "å“­ç¬‘ä¸å¾—", "çœ¼å·´å·´", "ç„å‡†", "å¿ƒæƒŠèƒ†æˆ˜"
        ]
      },
      {
        name: "ç¬¬18-19è¯¾ (å¨å°¼æ–¯ã€ç‰§åœº)",
        words: [
          "å°¼å§‘", "å°¼é¾™", "æ–¯æ–‡", "ç“¦æ–¯", "æ¸¸è‰‡", "æ½œæ°´è‰‡", "çºµæ¨ª", "çºµèº«", "èˆ¹è‰„",
          "ç¿˜èµ·", "ç¿˜é¦–", "å«å­", "åºŠå«", "ä¿å§†", "ç¥·å‘Š", "ç¥ˆç¥·", "é›‡ä½£", "è§£é›‡",
          "ç°‡æ‹¥", "èŠ±å›¢é”¦ç°‡", "å“—ç„¶", "å–§å“—", "å·ç ", "ç å¤´", "æ“çºµ", "æ‰‹å¿™è„šä¹±",
          "æ²‰å¯‚", "åœæ³Š", "ç¬¼ç½©", "ç«¯åº„", "ä»ªæ€", "è¿œçœº", "çœºæœ›", "éªé©¬", "è‹±ä¿Š",
          "å¥”é©°", "æ¾å¼›", "è¾½é˜”", "è¾½è¿œ", "ç»µç¾Š", "ç»µå»¶", "æ¿å‡³", "å‡³å­", "å†å–",
          "é“ƒå£°", "é“ƒé“›", "ç½å¤´", "ç“¦ç½", "æ¢å¤", "å¤©ç½‘æ¢æ¢", "è¸¢çƒ", "è¸¢è¸",
          "ç‰ºç‰²", "ç•œç‰²", "ç‰²ç•œ", "å®¶ç•œ", "é®æ©", "é˜»æŒ¡", "é£é©°", "èµè®¸", "æ²‰ç¡", "ç¯å¡”"
        ]
      },
      {
        name: "ç¬¬21-22è¯¾ (æ¨æ°ä¹‹å­ã€æ‰‹æŒ‡)",
        words: [
          "æ ‹æ¢", "æ¡¥æ¢", "èªæ˜", "èªæ…§", "é€ è¯£", "è‹¦å¿ƒå­¤è¯£", "å®¶ç¦½", "é£ç¦½",
          "æ‹‡æŒ‡", "å¤§æ‹‡æŒ‡", "æ”ç—’", "æ”å¤´", "å‘ç—’", "æŒ ç—’ç—’", "æ±¡ç§½", "ç§½ç‰©",
          "è½§é’¢", "è½§è·¯æœº", "æ‹§å¼€", "æ‹§å¹²", "èºä¸", "æµ·èº", "çº½æ‰£", "æ¢çº½",
          "æ‰£å­", "æŠ˜æ‰£", "ç¤¼è²Œ", "ç›¸è²Œ", "ä»“åº“", "ä»“ä¿ƒ", "æ¸ºå°", "æ¸ºèŒ«",
          "äº«å—", "åˆ†äº«", "å¹³åº¸", "åº¸ä¿—", "æ†æ¨", "çˆ±æ†åˆ†æ˜", "æ¥è§¦", "å…»å°Šå¤„ä¼˜",
          "äº«ä¹", "é™„åº¸", "å›¢ç»“"
        ]
      }
    ];

    // --- å…¨å±€å˜é‡ ---
    let currentSessionList = [];
    let currentIndex = 0;
    let isRunning = false;
    let isPaused = false;
    let synth = window.speechSynthesis;

    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    // ====== æ–°å¢ï¼šæç®€â€œè¿ç»­å¤©æ•° + é‡‘å¥ + é‡Œç¨‹ç¢‘â€ ======
    const QUOTES = [
      "ç§¯å°‘æˆå¤šï¼Œä»Šå¤©çš„10åˆ†é’Ÿï¼Œæ˜¯æ˜å¤©çš„åº•æ°”ã€‚",
      "ä½ ä¸æ˜¯åœ¨å¬å†™ï¼Œä½ æ˜¯åœ¨è®­ç»ƒâ€œåšæŒâ€ã€‚",
      "æ¯å†™å¯¹ä¸€ä¸ªå­—ï¼Œéƒ½æ˜¯åœ¨ç»™æœªæ¥çš„è‡ªå·±åŠ åˆ†ã€‚",
      "æŠŠâ€œä¸ä¼šâ€æ”¹æˆâ€œè¿˜æ²¡ä¼šâ€ã€‚",
      "æ…¢ä¸€ç‚¹æ²¡å…³ç³»ï¼Œè®¤çœŸå°±æ˜¯æœ€å¼ºçš„é€Ÿåº¦ã€‚",
      "ä»Šå¤©æ¯”æ˜¨å¤©å¤šä¼šä¸€ä¸ªè¯ï¼Œä½ å°±èµ¢äº†ã€‚"
    ];

    function pick(arr) { return arr[Math.floor(Math.random() * arr.length)]; }

    // æ‰‹æœºæµè§ˆå™¨å¯ç´¯è®¡ï¼šlocalStorageï¼ˆåŒä¸€æµè§ˆå™¨æœ‰æ•ˆï¼›æ¸…ç†ç¼“å­˜/æ— ç—•ä¼šä¸¢ï¼‰
    function loadStreak() {
      const streak = parseInt(localStorage.getItem("dict_streak_simple") || "0", 10);
      const el = document.getElementById("streak");
      if (el) el.innerText = `è¿ç»­ï¼š${streak}å¤©`;
    }

    function saveStreakOnFinish() {
      const today = new Date().toISOString().slice(0, 10);
      const last = localStorage.getItem("dict_last_day_simple");
      let streak = parseInt(localStorage.getItem("dict_streak_simple") || "0", 10);

      if (last === today) {
        // ä»Šå¤©å·²ç»è®°è¿‡ä¸€æ¬¡ï¼Œä¸é‡å¤åŠ 
      } else {
        // ä¸æ˜¯åŒä¸€å¤©ï¼šå°± +1ï¼ˆç®€å•ç­–ç•¥ï¼‰
        streak = streak + 1;
        localStorage.setItem("dict_last_day_simple", today);
        localStorage.setItem("dict_streak_simple", String(streak));
      }

      const el = document.getElementById("streak");
      if (el) el.innerText = `è¿ç»­ï¼š${streak}å¤©`;
    }

    function refreshQuote() {
      const qt = document.getElementById("quoteText");
      if (qt) qt.innerText = pick(QUOTES);
    }

    function setGoal(total) {
      const tg = document.getElementById("todayGoal");
      if (tg) tg.innerText = `ç›®æ ‡ï¼š${total}è¯é€šå…³`;
    }

    function setLevel(n) {
      const chip = document.getElementById("levelChip");
      if (chip) chip.innerHTML = `ç¬¬ ${n} å…³<span class="spark">âœ¨</span>`;
    }

    function showMilestone(text) {
      const b = document.getElementById("milestoneBadge");
      if (!b) return;
      b.innerText = text;
      b.style.display = "inline-block";
      setTimeout(() => { b.style.display = "none"; }, 1100);
    }
    // ====== æ–°å¢ç»“æŸ ======

    // --- åˆå§‹åŒ– ---
    window.onload = function () {
      initLessonSelector();
      loadStreak();
      refreshQuote();
    }

    // åŠ¨æ€ç”Ÿæˆä¸‹æ‹‰èœå•
    function initLessonSelector() {
      const select = document.getElementById('lessonSelect');
      select.innerHTML = '';

      lessonGroups.forEach((group, index) => {
        const option = document.createElement('option');
        option.value = index;
        const uniqueCount = new Set(group.words).size;
        option.text = `${group.name} [${uniqueCount}è¯]`;
        select.appendChild(option);
      });

      if (lessonGroups.length > 0) previewWords();
    }

    // é¢„è§ˆé€‰ä¸­çš„è¯è¯­
    function previewWords() {
      const index = document.getElementById('lessonSelect').value;
      const words = lessonGroups[index].words;
      const uniqueWords = [...new Set(words)];
      document.getElementById('wordPreview').innerText = uniqueWords.join("ã€");
    }

    function toggleCustomArea() {
      const area = document.getElementById('customInputArea');
      area.style.display = area.style.display === 'none' ? 'block' : 'none';
    }

    // --- å¬å†™é€»è¾‘ ---
    function initDictation() {
      const customInput = document.getElementById('customWordInput').value.trim();

      if (customInput.length > 0) {
        currentSessionList = processTextToWords(customInput);
        if (currentSessionList.length === 0) {
          alert("æ²¡æœ‰è¯†åˆ«åˆ°æœ‰æ•ˆçš„ä¸­æ–‡è¯è¯­ï¼Œè¯·é‡æ–°è¾“å…¥ã€‚");
          return;
        }
      } else {
        const index = document.getElementById('lessonSelect').value;
        currentSessionList = [...new Set(lessonGroups[index].words)];
      }

      // æ–°å¢ï¼šè®¾ç½®â€œä»Šæ—¥ç›®æ ‡â€
      setGoal(currentSessionList.length);

      document.getElementById('setupArea').style.display = 'none';
      document.getElementById('runningArea').style.display = 'block';
      document.getElementById('answerList').style.display = 'none';
      document.getElementById('answerList').innerHTML = '';

      startSession();
    }

    function processTextToWords(text) {
      const extracted = text.match(/[\u4e00-\u9fa5]+/g);
      if (!extracted) return [];
      return [...new Set(extracted.filter(w => w.length >= 1))];
    }

    // --- æ ¸å¿ƒå¾ªç¯ ---
    async function startSession() {
      isRunning = true;
      isPaused = false;
      currentIndex = 0;
      document.getElementById('pauseBtn').innerText = 'æš‚åœ';
      document.getElementById('pauseBtn').style.display = 'inline-block';

      const display = document.getElementById('wordDisplay');
      const status = document.getElementById('statusMsg');

      // 3ç§’å€’è®¡æ—¶
      status.innerText = "å‡†å¤‡å¼€å§‹...";
      for (let i = 3; i > 0; i--) {
        display.innerText = i;
        await sleep(1000);
      }

      while (currentIndex < currentSessionList.length && isRunning) {
        updateProgress();
        await checkPause();
        if (!isRunning) break;

        // æ–°å¢ï¼šæ›´æ–°å…³å¡ + å¶å°”æ¢é‡‘å¥
        setLevel(currentIndex + 1);
        if (currentIndex % 5 === 0) refreshQuote();

        const word = currentSessionList[currentIndex];

        display.innerText = `ç¬¬ ${currentIndex + 1} ä¸ª`;
        display.style.color = '#431407';
        status.innerText = 'æ­£åœ¨æœ—è¯»...';

        const repeat = parseInt(document.getElementById('repeatCount').value);

        // æœ—è¯»å¾ªç¯
        for (let r = 0; r < repeat; r++) {
          await checkPause();
          if (!isRunning) break;

          await speakWord(word);

          if (r < repeat - 1) {
            await sleep(1500);
          }
        }

        if (!isRunning) break;
        status.innerText = 'è¯·ä¹¦å†™...';
        display.style.color = '#e5e7eb';

        const waitTime = parseInt(document.getElementById('waitTime').value) * 10;
        for (let t = 0; t < waitTime; t++) {
          await checkPause();
          if (!isRunning) break;
          await sleep(100);
        }

        currentIndex++;

        // æ–°å¢ï¼šé‡Œç¨‹ç¢‘æç¤ºï¼ˆå¾ˆè½»é‡ï¼‰
        if (currentIndex === 5) showMilestone("ğŸ‰ 5å…³è¾¾æˆï¼");
        if (currentIndex === 10) showMilestone("ğŸŒŸ 10å…³è¾¾æˆï¼");
        if (currentIndex === 20) showMilestone("ğŸ† 20å…³è¾¾æˆï¼");
      }

      if (isRunning) {
        finishDictation();
      }
    }

    // è¯­éŸ³åˆæˆ (æ”¯æŒåŠ¨æ€è¯­é€Ÿ)
    function speakWord(text) {
      return new Promise((resolve) => {
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'zh-CN';

        const selectedRate = document.getElementById('speechRate').value;
        u.rate = parseFloat(selectedRate);

        u.onend = resolve;
        u.onerror = (e) => {
          console.error("Speech error", e);
          resolve();
        };
        synth.speak(u);
      });
    }

    function updateProgress() {
      const total = currentSessionList.length;
      document.getElementById('progressText').innerText = `è¿›åº¦: ${currentIndex} / ${total}`;
      const pct = (currentIndex / total) * 100;
      document.getElementById('progressFill').style.width = `${pct}%`;
    }

    async function checkPause() {
      while (isPaused && isRunning) {
        await sleep(200);
      }
    }

    function togglePause() {
      isPaused = !isPaused;
      const btn = document.getElementById('pauseBtn');
      if (isPaused) {
        synth.cancel();
        btn.innerText = 'ç»§ç»­';
        btn.style.background = "#dcfce7";
        btn.style.color = "#166534";
        document.getElementById('statusMsg').innerText = 'â¸ å·²æš‚åœ';
      } else {
        btn.innerText = 'æš‚åœ';
        btn.style.background = "#fef9c3";
        btn.style.color = "#b45309";
      }
    }

    function stopDictation() {
      if (confirm("ç¡®å®šè¦ç»“æŸå¬å†™å—ï¼Ÿ")) {
        isRunning = false;
        synth.cancel();
        document.getElementById('runningArea').style.display = 'none';
        document.getElementById('setupArea').style.display = 'block';
      }
    }

    function finishDictation() {
      // æ–°å¢ï¼šå®Œæˆåç´¯è®¡è¿ç»­å¤©æ•°ï¼ˆæç®€ç‰ˆï¼‰
      saveStreakOnFinish();

      document.getElementById('wordDisplay').innerText = "ğŸ‰ é€šå…³ï¼";
      document.getElementById('statusMsg').innerText = "ä½ åˆæ¯”æ˜¨å¤©æ›´å¼ºäº†ä¸€ç‚¹ç‚¹ ğŸ’ª";

      const list = document.getElementById('answerList');
      let html = `
        <div style="background:#ffedd5;border:1px solid #fed7aa;border-radius:14px;padding:12px 14px;margin-bottom:12px;">
          <div style="font-weight:900;color:#9a3412;">ğŸ ä»Šæ—¥é€šå…³å¡</div>
          <div style="margin-top:6px;color:#7c2d12;font-weight:700;">
            æœ¬æ¬¡é€šå…³ï¼š${currentSessionList.length} è¯ï½œå¥–åŠ±ï¼šåšæŒ +1
          </div>
          <div style="margin-top:4px;color:#9a3412;font-size:0.85rem;">
            ç§¯å°‘æˆå¤šï¼Œä»Šå¤©çš„è®¤çœŸä¼šåœ¨æ˜å¤©å‘å…‰ã€‚
          </div>
        </div>
      `;
      html += '<h3 style="margin-bottom:15px; color:#c2410c;">âœ… ç­”æ¡ˆæ ¸å¯¹</h3><div class="answer-grid">';

      currentSessionList.forEach((w, i) => {
        html += `<div class="answer-item"><span style="font-size:0.7em;color:#aaa;display:block">${i + 1}</span>${w}</div>`;
      });
      html += '</div>';

      list.innerHTML = html;
      list.style.display = 'block';
      document.getElementById('pauseBtn').style.display = 'none';
      document.getElementById('progressFill').style.width = '100%';

      setTimeout(() => {
        list.scrollIntoView({ behavior: 'smooth' });
      }, 500);
    }

    async function handlePdfUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      const statusEl = document.getElementById('ocrStatus');
      statusEl.innerText = 'â³ æ­£åœ¨è§£æ PDF...';
      try {
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
        let fullText = '';
        for (let i = 1; i <= pdf.numPages; i++) {
          const page = await pdf.getPage(i);
          const textContent = await page.getTextContent();
          fullText += textContent.items.map(item => item.str).join(' ');
        }
        document.getElementById('customWordInput').value = fullText;
        statusEl.innerText = 'âœ… è§£ææˆåŠŸï¼Œè¯·ç‚¹å‡»â€œå¼€å§‹å¬å†™â€';
      } catch (e) {
        console.error(e);
        statusEl.innerText = 'âŒ è§£æå¤±è´¥ï¼Œè¯·é‡è¯•';
      }
    }

    function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }
  </script>

</body>
</html>
